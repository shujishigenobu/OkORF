blast7 = ARGV[0] # required
fasta = ARGV[1] # CDS fasta generated by TransDecoder; option only required if 'use_only_complete_orfs_for_training == true'
use_only_complete_orfs_for_training = ARGV[2]

### Parse fasta header to build id<=>type hash
id2orftype = {}
if fasta
  File.open(fasta).each do |l|
    if /^>/.match(l)
      id = />(\S+?)\s/.match(l)[1]
      t = /\stype:(.+)\s+len/.match(l)[1]
      id2orftype[id] = t
    end
  end
end

### Parse blast result and choose good model
prev_line = ""
File.open(blast7).each do |l|
  next if /^\#/.match(l)
  a = l.chomp.split(/\t/, -1)
  query = a[0]
  query_prev = prev_line.split(/\t/, -1)[0]

  unless query == query_prev
#    puts l 

    qid = a[0]
    sid = a[1]
    perc_identity = a[2].to_f
    align_len = a[3].to_i
    qlen = a[12].to_i
    slen = a[13].to_i
    evalue = a[10].to_f
    
#p    [qid, sid, perc_identity, align_len, qlen, slen]

    len_diff_perc = (qlen/slen.to_f - 1.0).abs * 100
    len_avg = (qlen + slen) / 2.0
    
    aln_ratio = (align_len / len_avg) 

#    p [qid, sid, perc_identity, align_len, qlen, slen, len_diff, aln_ratio]

    orftype_passed = true
    orftype = id2orftype[qid]
    if use_only_complete_orfs_for_training &&
        orftype != "complete"
      orftype_passed = false
    end

    if (perc_identity > 30.0  &&
        aln_ratio > 0.5 &&
        len_diff_perc < 20 &&
        qlen > 300 &&
        evalue < 1.0e-8 &&
        orftype_passed
        )
      
      puts [qid, sid, perc_identity, align_len, qlen, slen, len_diff_perc, aln_ratio, "*"].join("\t")
    end

  end

  prev_line = l
end
